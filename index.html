<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pixmap War Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body { height: 100%; margin: 0; font-family: sans-serif; background:#000; }
#map { position: absolute; top:0; left:0; right:0; bottom:0; z-index:0; }

/* --- Top bar --- */
#topbar {
  position: absolute; top:0; left:0; right:0; height:60px;
  background:rgba(255,255,255,0.95);
  display:flex; justify-content:center; align-items:center;
  z-index:9999;
  box-shadow:0 2px 5px rgba(0,0,0,0.5);
}
#topbar img { height:40px; margin:0 10px; cursor:pointer; filter: invert(0); }
#topbar .telegram { position:absolute; right:10px; cursor:pointer; }

/* Texto "Hola" junto al logo */
#greeting {
  font-size: 15px;
  font-weight: bold;
  color: #000;
  margin-left: 10px;
}

/* --- Sidebar de noticias --- */
#sidebar {
  position: absolute; top:60px; right:0; width:300px; bottom:0; overflow-y:auto;
  background:rgba(0,0,0,0.7); padding:10px;
  box-shadow:-2px 0 5px rgba(0,0,0,0.5); z-index:9999;
  color:white;
  border-radius:10px 0 0 10px;
}

.event-item { 
  margin-bottom:12px; 
  border-radius:10px; 
  padding:10px; 
  background:rgba(30,30,30,0.8); 
  box-shadow:0 2px 5px rgba(0,0,0,0.5);
  cursor:pointer; 
}
.event-header { display:flex; }
.event-marker-dot { width:12px; height:12px; border-radius:50%; margin-right:8px; }
.event-content { flex:1; }
.event-meta { font-size:12px; color:#aaa; display:flex; justify-content:space-between; }
.event-title { margin:4px 0; font-size:14px; font-weight:bold; color:white; }
.event-description { font-size:12px; margin:2px 0; color:#ddd; }

/* --- Bot√≥n para mostrar barra de noticias --- */
#showSidebarBtn {
  display: none;
  position: absolute;
  top: 70px;
  right: 10px;
  z-index: 10000;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: none;
  background-color: white;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  cursor: pointer;
  padding: 5px;
}
#showSidebarBtn img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="topbar">
  <img src="recursos/logo.png" alt="Logo">
  <span id="greeting">#FreeChristianityinandIslamPixmap </span>
  <img src="recursos/telegram.png" class="telegram" alt="Telegram" onclick="window.open('https://t.me/DEzeitung','_blank')">
</div>

<div id="sidebar">
  <h3 id="newsTitle" style="cursor:pointer;">News</h3>
  <div id="newsContainer"></div>
</div>

<button id="showSidebarBtn">
  <img src="recursos/newspaper.png" alt="News" />
</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

<script>
// ======= MAPA =======
const map = L.map('map').setView([48.5, 32], 5);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

const frentesLayer = new L.LayerGroup().addTo(map);
const tropasLayer = new L.LayerGroup().addTo(map);

// ======= FUNCIONES =======
function resolveIconUrl(props) {
  if (props.image) return props.image;

  const basePath = 'recursos/';
  const posiblesNombres = [];

  if (props.tipo) posiblesNombres.push(String(props.tipo).toLowerCase());
  if (props.name) posiblesNombres.push(String(props.name).toLowerCase());
  if (props.icon) posiblesNombres.push(String(props.icon).toLowerCase());

  for (let name of posiblesNombres) {
    const posibles = ['png','jpg','jpeg','webp','gif'];
    for (let ext of posibles) return basePath + name + '.' + ext;
  }
  return null;
}

// ======= CARGAR FRENTES =======
async function loadFrentes() {
  try {
    const res = await fetch('frentes.json');
    const data = await res.json();

    frentesLayer.clearLayers();
    tropasLayer.clearLayers();

    const features = data.features || data;
    features.forEach(f => {
      if (!f.geometry) return;
      const props = f.properties || {};

      if (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon') {
        const coords = f.geometry.coordinates[0].map(c => [c[1], c[0]]);
        const poly = L.polygon(coords, {
          color: props.color || '#ff0000',
          fillOpacity: props.fillOpacity || 0.4,
          weight: props.weight || 2
        });
        if (props.name) poly.bindPopup(`<b>${props.name}</b>`);
        frentesLayer.addLayer(poly);
      }

      if (f.geometry.type === 'Point') {
        const lat = f.geometry.coordinates[1];
        const lng = f.geometry.coordinates[0];
        const iconUrl = resolveIconUrl(props);
        let marker;
        if (iconUrl) {
          const icon = L.icon({
            iconUrl,
            iconSize: props.iconSize || [32, 32],
            iconAnchor: props.iconAnchor || [16, 16]
          });
          marker = L.marker([lat, lng], { icon, rotationAngle: props.angle || 0 });
        } else {
          marker = L.marker([lat, lng]);
        }
        if (props.name) marker.bindPopup(`<b>${props.name}</b>`);
        tropasLayer.addLayer(marker);
      }
    });
  } catch (err) {
    console.error('Error cargando frentes.json', err);
  }
}
loadFrentes();

// ======= NOTICIAS =======
const sidebar = document.getElementById('sidebar');
const newsTitle = document.getElementById('newsTitle');
const showSidebarBtn = document.getElementById('showSidebarBtn');
const newsContainer = document.getElementById('newsContainer');

newsTitle.addEventListener('click', () => {
  sidebar.style.display='none';
  showSidebarBtn.style.display='block';
});
showSidebarBtn.addEventListener('click', () => {
  sidebar.style.display='block';
  showSidebarBtn.style.display='none';
});

async function loadNews() {
  try {
    const res = await fetch('noticias.json');
    const noticias = await res.json();
    newsContainer.innerHTML = '';
    noticias.forEach(n => {
      const div = document.createElement('div');
      div.className = 'event-item';
      div.innerHTML = `
        <div class="event-header">
          <div class="event-marker-dot" style="background:hsl(200,70%,55%)"></div>
          <div class="event-content">
            <div class="event-meta">
              <span class="badge">${n.tipo || 'Info'}</span>
              <span class="time">${n.time || 'Just now'}</span>
            </div>
            <h3 class="event-title">${n.text || ''}</h3>
            <p class="event-description">${n.description || ''}</p>
          </div>
        </div>`;
      newsContainer.appendChild(div);
    });
  } catch (err) {
    console.error('Error cargando noticias.json', err);
  }
}
loadNews();
</script>
</body>
</html>

